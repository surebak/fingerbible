<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <title>ì†ê°€ë½ ì„±ê²½</title>
    
    <!-- Base URL for all relative URLs in the document -->
    <base href="/">
    
    <!-- Canonical URL (ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¨) -->
    <link rel="canonical" href="https://fingerbible.com/" id="canonical-url">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    
    <!-- Viewport Settings -->
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=5, viewport-fit=cover">
    
    <!-- PWA Capabilities -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ì†ê°€ë½ì„±ê²½">
    
    <!-- Theme Colors -->
    <meta name="theme-color" content="#ff0044">
    <meta name="msapplication-TileColor" content="#ff0044">
    <meta name="msapplication-navbutton-color" content="#ff0044">
    <meta name="apple-mobile-web-app-status-bar-style" content="#ff0044">
    
    <!-- SEO Meta Tags -->
    <meta name="keywords" content="ìƒˆë²ˆì—­, ìƒˆë²ˆì—­ì„±ê²½, ê°œì—­ê°œì •,ê°œì—­ê°œì •ì„±ê²½,ì˜¨ë¼ì¸ì„±ê²½,ì¸í„°ë„·ê°œì—­ê°œì •,ì„±ê²½,ë°”ì´ë¸”,í•œê¸€ì„±ê²½,ëª¨ë°”ì¼,ëª¨ì•„ë¹Œì›¹,ì˜¨ë¼ì¸,ì›¹ì•±,webapp,PWA" />
    <meta name="description" content="ëª¨ë°”ì¼ê¸°ê¸° ìŠ¤ë§ˆíŠ¸í° ë“±ì—ì„œ í¸ë¦¬í•˜ê²Œ ë³¼ ìˆ˜ ìˆëŠ” ì˜¨ë¼ì¸ í•œê¸€ ê°œì—­ê°œì •/ìƒˆë²ˆì—­ ì„±ê²½ì…ë‹ˆë‹¤." />
    <meta name="author" content="ì†ê°€ë½ì„±ê²½">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.fingerbible.com" />
    <meta property="og:title" content="ì†ê°€ë½ ì„±ê²½" />
    <meta property="og:description" content="ëª¨ë°”ì¼ê¸°ê¸° ìŠ¤ë§ˆíŠ¸í° ë“±ì—ì„œ í¸ë¦¬í•˜ê²Œ ë³¼ ìˆ˜ ìˆëŠ” ì˜¨ë¼ì¸ í•œê¸€ ê°œì—­ê°œì •/ìƒˆë²ˆì—­ ì„±ê²½ì…ë‹ˆë‹¤." />
    <meta property="og:image" content="https://fingerbible.com/ogimg.png" />
    <meta property="og:site_name" content="ì†ê°€ë½ì„±ê²½" />
    <meta property="fb:app_id" content="1522654831340442" />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ì†ê°€ë½ ì„±ê²½">
    <meta name="twitter:description" content="ëª¨ë°”ì¼ê¸°ê¸° ìŠ¤ë§ˆíŠ¸í° ë“±ì—ì„œ í¸ë¦¬í•˜ê²Œ ë³¼ ìˆ˜ ìˆëŠ” ì˜¨ë¼ì¸ í•œê¸€ ê°œì—­ê°œì •/ìƒˆë²ˆì—­ ì„±ê²½ì…ë‹ˆë‹¤.">
    <meta name="twitter:image" content="https://fingerbible.com/ogimg.png">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple_icon.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple_icon.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/apple_icon.png">
    <link rel="shortcut icon" href="/icon.png">
    
    <!-- iOS Splash Screens -->
    <link rel="apple-touch-startup-image" href="/ogimg.png">
    
    <!-- Microsoft -->
    <meta name="msapplication-TileImage" content="/icon.png">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/css/fingerbible.css">
    
    <!-- Scripts -->
    <script src="/js/jquery-3.3.1.min.js"></script>
    <script src="/js/vue.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.5/firebase.js"></script>
    <script src="https://cdn.firebase.com/libs/firebaseui/3.1.1/firebaseui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard@1/dist/clipboard.min.js"></script>
    <script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
        ga('create', 'UA-57744362-1', 'auto');
        ga('send', 'pageview');
    </script>
</head>

<body class='c_reading' data-version="krv">
    <div class="block_loading">
        <i class="icon-t_1"></i>
        <i class="icon-t_2"></i>
        <i class="icon-t_3"></i>
        <i class="icon-t_4"></i>
        <i class="icon-t_5"></i>
        <i class="icon-t_6"></i>
        <i class="icon-t_7"></i>
        <i class="icon-t_8"></i>
    </div>
    <div class="float">
        <div class="close"></div>
        <p class="selection"></p>
        <div class="copy_me" data-clipboard-target="#copyme">ë³µì‚¬í•˜ê¸°</div>
    </div>
    
    <!-- PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ -->
    <div class="pwa-install-prompt" id="pwa-install-prompt" style="display: none;">
        <div class="pwa-prompt-content">
            <button class="pwa-close" id="pwa-close-btn">&times;</button>
            <div class="pwa-icon">
                <img src="/icon.png" alt="ì†ê°€ë½ ì„±ê²½" width="60" height="60">
            </div>
            <div class="pwa-text">
                <h3>ì†ê°€ë½ ì„±ê²½ ì„¤ì¹˜</h3>
                <p>í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ì—¬ ì•±ì²˜ëŸ¼ ì‚¬ìš©í•˜ì„¸ìš”</p>
            </div>
            <button class="pwa-install-btn" id="pwa-install-btn">ì„¤ì¹˜í•˜ê¸°</button>
        </div>
    </div>
    <div class="books">
        <div class="selected" data-ch='50' data-book="gen">ì°½ì„¸ê¸°</div>
        <div data-ch='40' data-book="exo">ì¶œì• êµ½ê¸°</div>
        <div data-ch='27' data-book="lev">ë ˆìœ„ê¸°</div>
        <div data-ch='36' data-book="num">ë¯¼ìˆ˜ê¸°</div>
        <div data-ch='34' data-book="deut">ì‹ ëª…ê¸°</div>
        <div data-ch='24' data-book="jos">ì—¬í˜¸ìˆ˜ì•„</div>
        <div data-ch='21' data-book="jdg">ì‚¬ì‚¬ê¸°</div>
        <div data-ch='4' data-book="rth">ë£»ê¸°</div>
        <div data-ch='31' data-book="1sam">ì‚¬ë¬´ì—˜ìƒ</div>
        <div data-ch='24' data-book="2sam">ì‚¬ë¬´ì—˜í•˜</div>
        <div data-ch='22' data-book="1kgs">ì—´ì™•ê¸°ìƒ</div>
        <div data-ch='25' data-book="2kgs">ì—´ì™•ê¸°í•˜</div>
        <div data-ch='29' data-book="1chr">ì—­ëŒ€ìƒ</div>
        <div data-ch='36' data-book="2chr">ì—­ëŒ€í•˜</div>
        <div data-ch='10' data-book="ezr">ì—ìŠ¤ë¼</div>
        <div data-ch='13' data-book="neh">ëŠí—¤ë¯¸ì•¼</div>
        <div data-ch='10' data-book="esth">ì—ìŠ¤ë”</div>
        <div data-ch='42' data-book="job">ìš¥ê¸°</div>
        <div data-ch='150' data-book="psm">ì‹œí¸</div>
        <div data-ch='31' data-book="prv">ì ì–¸</div>
        <div data-ch='12' data-book="ecc">ì „ë„ì„œ</div>
        <div data-ch='8' data-book="song">ì•„ê°€</div>
        <div data-ch='66' data-book="isa">ì´ì‚¬ì•¼</div>
        <div data-ch='52' data-book="jer">ì˜ˆë ˆë¯¸ì•¼</div>
        <div data-ch='5' data-book="lam">ì˜ˆë ˆë¯¸ì•¼ ì• ê°€</div>
        <div data-ch='48' data-book="ezk">ì—ìŠ¤ê²”</div>
        <div data-ch='12' data-book="dan">ë‹¤ë‹ˆì—˜</div>
        <div data-ch='14' data-book="hos">í˜¸ì„¸ì•„</div>
        <div data-ch='3' data-book="joel">ìš”ì—˜</div>
        <div data-ch='9' data-book="amos">ì•„ëª¨ìŠ¤</div>
        <div data-ch='1' data-book="obad">ì˜¤ë°”ëŒœ</div>
        <div data-ch='4' data-book="jon">ìš”ë‚˜</div>
        <div data-ch='7' data-book="mic">ë¯¸ê°€</div>
        <div data-ch='3' data-book="nah">ë‚˜í›”</div>
        <div data-ch='3' data-book="hab">í•˜ë°•êµ­</div>
        <div data-ch='3' data-book="zep">ìŠ¤ë°”ëƒ</div>
        <div data-ch='2' data-book="hag">í•™ê°œ</div>
        <div data-ch='14' data-book="zec">ìŠ¤ê°€ë´</div>
        <div data-ch='4' data-book="mal">ë§ë¼ê¸°</div>
        <div data-ch='28' data-book="mat">ë§ˆíƒœë³µìŒ</div>
        <div data-ch='16' data-book="mrk">ë§ˆê°€ë³µìŒ</div>
        <div data-ch='24' data-book="luk">ëˆ„ê°€ë³µìŒ</div>
        <div data-ch='21' data-book="john">ìš”í•œë³µìŒ</div>
        <div data-ch='28' data-book="acts">ì‚¬ë„í–‰ì „</div>
        <div data-ch='16' data-book="rom">ë¡œë§ˆì„œ</div>
        <div data-ch='16' data-book="1cor">ê³ ë¦°ë„ì „ì„œ</div>
        <div data-ch='13' data-book="2cor">ê³ ë¦°ë„í›„ì„œ</div>
        <div data-ch='6' data-book="gal">ê°ˆë¼ë””ì•„ì„œ</div>
        <div data-ch='6' data-book="eph">ì—ë² ì†Œì„œ</div>
        <div data-ch='4' data-book="phil">ë¹Œë¦½ë³´ì„œ</div>
        <div data-ch='4' data-book="col">ê³¨ë¡œìƒˆì„œ</div>
        <div data-ch='5' data-book="1the">ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ</div>
        <div data-ch='3' data-book="2the">ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ</div>
        <div data-ch='6' data-book="1tim">ë””ëª¨ë°ì „ì„œ</div>
        <div data-ch='4' data-book="2tim">ë””ëª¨ë°í›„ì„œ</div>
        <div data-ch='3' data-book="tit">ë””ë„ì„œ</div>
        <div data-ch='1' data-book="phm">ë¹Œë ˆëª¬ì„œ</div>
        <div data-ch='13' data-book="heb">íˆë¸Œë¦¬ì„œ</div>
        <div data-ch='5' data-book="jas">ì•¼ê³ ë³´ì„œ</div>
        <div data-ch='5' data-book="1pet">ë² ë“œë¡œì „ì„œ</div>
        <div data-ch='3' data-book="2pet">ë² ë“œë¡œí›„ì„œ</div>
        <div data-ch='5' data-book="1jn">ìš”í•œì¼ì„œ</div>
        <div data-ch='1' data-book="2jn">ìš”í•œì´ì„œ</div>
        <div data-ch='1' data-book="3jn">ìš”í•œì‚¼ì„œ</div>
        <div data-ch='1' data-book="jud">ìœ ë‹¤ì„œ</div>
        <div data-ch='22' data-book="rev">ìš”í•œê³„ì‹œë¡</div>
    </div>
    <div class="chapters"></div>
    <div class="config">
        <li id="current">
            <p>ì½ê¸°</p>
            <select>
                <option value="krv">ê°œì—­ê°œì •</option>
                <option value="rnksv" selected="selected">ìƒˆë²ˆì—­</option>
            </select>
        </li>
        <li id="font_inc">ê¸€ì”¨ +</li>
        <li id="font_dec">ê¸€ì”¨ -</li>
        <li id="inline">ì¤„ë°”ê¿ˆ</li>
        <li id="colormode">ìƒ‰ì±„</li>
        <li id="install_app" class="install-menu" style="display: none;">
            <span class="install-icon">ğŸ“±</span>
            ì„¤ì¹˜í•˜ê¸°
        </li>
    </div>
    <header>
        <div class="btn left"></div>
        <div class="title"></div>
        <div class="btn right">
            <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                x="0px" y="0px" viewBox="0 0 478.703 478.703" style="enable-background:new 0 0 478.703 478.703;"
                xml:space="preserve">
                <path d="M454.2,189.101l-33.6-5.7c-3.5-11.3-8-22.2-13.5-32.6l19.8-27.7c8.4-11.8,7.1-27.9-3.2-38.1l-29.8-29.8
            c-5.6-5.6-13-8.7-20.9-8.7c-6.2,0-12.1,1.9-17.1,5.5l-27.8,19.8c-10.8-5.7-22.1-10.4-33.8-13.9l-5.6-33.2
            c-2.4-14.3-14.7-24.7-29.2-24.7h-42.1c-14.5,0-26.8,10.4-29.2,24.7l-5.8,34c-11.2,3.5-22.1,8.1-32.5,13.7l-27.5-19.8
            c-5-3.6-11-5.5-17.2-5.5c-7.9,0-15.4,3.1-20.9,8.7l-29.9,29.8c-10.2,10.2-11.6,26.3-3.2,38.1l20,28.1
            c-5.5,10.5-9.9,21.4-13.3,32.7l-33.2,5.6c-14.3,2.4-24.7,14.7-24.7,29.2v42.1c0,14.5,10.4,26.8,24.7,29.2l34,5.8
            c3.5,11.2,8.1,22.1,13.7,32.5l-19.7,27.4c-8.4,11.8-7.1,27.9,3.2,38.1l29.8,29.8c5.6,5.6,13,8.7,20.9,8.7c6.2,0,12.1-1.9,17.1-5.5
            l28.1-20c10.1,5.3,20.7,9.6,31.6,13l5.6,33.6c2.4,14.3,14.7,24.7,29.2,24.7h42.2c14.5,0,26.8-10.4,29.2-24.7l5.7-33.6
            c11.3-3.5,22.2-8,32.6-13.5l27.7,19.8c5,3.6,11,5.5,17.2,5.5l0,0c7.9,0,15.3-3.1,20.9-8.7l29.8-29.8c10.2-10.2,11.6-26.3,3.2-38.1
            l-19.8-27.8c5.5-10.5,10.1-21.4,13.5-32.6l33.6-5.6c14.3-2.4,24.7-14.7,24.7-29.2v-42.1
            C478.9,203.801,468.5,191.501,454.2,189.101z M451.9,260.401c0,1.3-0.9,2.4-2.2,2.6l-42,7c-5.3,0.9-9.5,4.8-10.8,9.9
            c-3.8,14.7-9.6,28.8-17.4,41.9c-2.7,4.6-2.5,10.3,0.6,14.7l24.7,34.8c0.7,1,0.6,2.5-0.3,3.4l-29.8,29.8c-0.7,0.7-1.4,0.8-1.9,0.8
            c-0.6,0-1.1-0.2-1.5-0.5l-34.7-24.7c-4.3-3.1-10.1-3.3-14.7-0.6c-13.1,7.8-27.2,13.6-41.9,17.4c-5.2,1.3-9.1,5.6-9.9,10.8l-7.1,42
            c-0.2,1.3-1.3,2.2-2.6,2.2h-42.1c-1.3,0-2.4-0.9-2.6-2.2l-7-42c-0.9-5.3-4.8-9.5-9.9-10.8c-14.3-3.7-28.1-9.4-41-16.8
            c-2.1-1.2-4.5-1.8-6.8-1.8c-2.7,0-5.5,0.8-7.8,2.5l-35,24.9c-0.5,0.3-1,0.5-1.5,0.5c-0.4,0-1.2-0.1-1.9-0.8l-29.8-29.8
            c-0.9-0.9-1-2.3-0.3-3.4l24.6-34.5c3.1-4.4,3.3-10.2,0.6-14.8c-7.8-13-13.8-27.1-17.6-41.8c-1.4-5.1-5.6-9-10.8-9.9l-42.3-7.2
            c-1.3-0.2-2.2-1.3-2.2-2.6v-42.1c0-1.3,0.9-2.4,2.2-2.6l41.7-7c5.3-0.9,9.6-4.8,10.9-10c3.7-14.7,9.4-28.9,17.1-42
            c2.7-4.6,2.4-10.3-0.7-14.6l-24.9-35c-0.7-1-0.6-2.5,0.3-3.4l29.8-29.8c0.7-0.7,1.4-0.8,1.9-0.8c0.6,0,1.1,0.2,1.5,0.5l34.5,24.6
            c4.4,3.1,10.2,3.3,14.8,0.6c13-7.8,27.1-13.8,41.8-17.6c5.1-1.4,9-5.6,9.9-10.8l7.2-42.3c0.2-1.3,1.3-2.2,2.6-2.2h42.1
            c1.3,0,2.4,0.9,2.6,2.2l7,41.7c0.9,5.3,4.8,9.6,10,10.9c15.1,3.8,29.5,9.7,42.9,17.6c4.6,2.7,10.3,2.5,14.7-0.6l34.5-24.8
            c0.5-0.3,1-0.5,1.5-0.5c0.4,0,1.2,0.1,1.9,0.8l29.8,29.8c0.9,0.9,1,2.3,0.3,3.4l-24.7,34.7c-3.1,4.3-3.3,10.1-0.6,14.7
            c7.8,13.1,13.6,27.2,17.4,41.9c1.3,5.2,5.6,9.1,10.8,9.9l42,7.1c1.3,0.2,2.2,1.3,2.2,2.6v42.1H451.9z" />
                <path
                    d="M239.4,136.001c-57,0-103.3,46.3-103.3,103.3s46.3,103.3,103.3,103.3s103.3-46.3,103.3-103.3S296.4,136.001,239.4,136.001
            z M239.4,315.601c-42.1,0-76.3-34.2-76.3-76.3s34.2-76.3,76.3-76.3s76.3,34.2,76.3,76.3S281.5,315.601,239.4,315.601z" />
            </svg>
        </div>
    </header>
    <div class="main">
        <div class="wrapper" id="b_text">
            <div class="text">
                <div v-for="(value,key,index) in bjson"><span>{{key}}</span>
                    <p>{{value}}</p>
                </div>
            </div>
        </div>
    </div>
    <input id="copyme" style="position: absolute;left: -999px;top:-999px;opacity: 0;z-index: -1;pointer-events: none"
        type="text" value=''>
</body>
<script>
    // var config = {
    //     databaseURL: "https://bibles-da0c4.firebaseio.com/",
    // };
    // firebase.initializeApp(config);

    var config = {
        apiKey: "AIzaSyAUqa0kNzRa94L50dwpc5rlPpQ0LOJSQnI",
        authDomain: "bibles-da0c4.firebaseapp.com",
        databaseURL: "https://bibles-da0c4.firebaseio.com",
        projectId: "bibles-da0c4",
        storageBucket: "bibles-da0c4.appspot.com"
    };
    firebase.initializeApp(config);

    var database = firebase.database();

    var version = 'rnksv'
    var book = 'gen'
    var chapter = 1;
    var l_chapter = 0;
    var book_title = ''
    var bible_json

    ////////////////////////////////////////////////////////////
    // URL ê´€ë¦¬ í•¨ìˆ˜ë“¤ (ë¼ìš°íŒ…)
    ////////////////////////////////////////////////////////////

    // URLì—ì„œ íŒŒë¼ë¯¸í„° ì½ê¸° (ê²½ë¡œ ë°©ì‹ + ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì§€ì›)
    function getUrlParams() {
        // 1. ê²½ë¡œ ë°©ì‹ íŒŒì‹±
        const path = window.location.pathname;
        const pathParts = path.split('/').filter(p => p);
        
        if (pathParts.length > 0) {
            // ìƒˆ í˜•ì‹: /version/book/chapter (ì˜ˆ: /krv/gen/1, /rnksv/john/3)
            if (pathParts.length >= 3 && (pathParts[0] === 'krv' || pathParts[0] === 'rnksv')) {
                return {
                    version: pathParts[0],
                    book: pathParts[1] || null,
                    chapter: pathParts[2] ? parseInt(pathParts[2]) : null,
                    isPathBased: true
                };
            }
            
            // êµ¬ í˜•ì‹ 1: /book/chapter/version (í•˜ìœ„ í˜¸í™˜)
            if (pathParts.length >= 3 && (pathParts[2] === 'krv' || pathParts[2] === 'rnksv')) {
                return {
                    book: pathParts[0] || null,
                    chapter: pathParts[1] ? parseInt(pathParts[1]) : null,
                    version: pathParts[2],
                    isPathBased: true,
                    isOldFormat: true
                };
            }
            
            // êµ¬ í˜•ì‹ 2: /book/chapter (ë²„ì „ ìƒëµ, ê¸°ë³¸ê°’ ì‚¬ìš©)
            if (pathParts.length >= 2) {
                // ì²« ë²ˆì§¸ê°€ ë²„ì „ ì½”ë“œê°€ ì•„ë‹ˆë©´ ì±… ì´ë¦„ìœ¼ë¡œ ê°„ì£¼
                if (pathParts[0] !== 'krv' && pathParts[0] !== 'rnksv') {
                    return {
                        book: pathParts[0] || null,
                        chapter: pathParts[1] ? parseInt(pathParts[1]) : null,
                        version: null, // ê¸°ë³¸ê°’ ì‚¬ìš©
                        isPathBased: true,
                        isOldFormat: true
                    };
                }
            }
            
            // /versionë§Œ ìˆëŠ” ê²½ìš° (ì˜ˆ: /krv)
            if (pathParts.length === 1 && (pathParts[0] === 'krv' || pathParts[0] === 'rnksv')) {
                return {
                    version: pathParts[0],
                    book: null,
                    chapter: null,
                    isPathBased: true
                };
            }
        }
        
        // 2. ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ë°©ì‹ (í•˜ìœ„ í˜¸í™˜ì„±)
        const params = new URLSearchParams(window.location.search);
        const queryBook = params.get('book');
        const queryChapter = params.get('chapter');
        const queryVersion = params.get('version');
        
        if (queryBook || queryChapter || queryVersion) {
            return {
                book: queryBook,
                chapter: queryChapter ? parseInt(queryChapter) : null,
                version: queryVersion,
                isPathBased: false
            };
        }
        
        // 3. íŒŒë¼ë¯¸í„° ì—†ìŒ
        return {
            book: null,
            chapter: null,
            version: null,
            isPathBased: false
        };
    }

    // URL ì—…ë°ì´íŠ¸ (History API ì‚¬ìš© - ê¹”ë”í•œ ê²½ë¡œ ë°©ì‹)
    function updateUrl(updateHistory = true) {
        // ìƒˆë¡œìš´ ê²½ë¡œ ë°©ì‹: /version/book/chapter
        let newUrl = `/${version}/${book}/${chapter}`;
        
        if (updateHistory) {
            // ìƒˆë¡œìš´ íˆìŠ¤í† ë¦¬ í•­ëª© ì¶”ê°€ (ë’¤ë¡œê°€ê¸° ê°€ëŠ¥)
            history.pushState({ book, chapter, version }, '', newUrl);
        } else {
            // í˜„ì¬ íˆìŠ¤í† ë¦¬ í•­ëª©ë§Œ ìˆ˜ì • (ë’¤ë¡œê°€ê¸° ë¶ˆê°€)
            history.replaceState({ book, chapter, version }, '', newUrl);
        }
        
        // ë©”íƒ€ íƒœê·¸ ì—…ë°ì´íŠ¸ (ê³µìœ  ì‹œ ìœ ìš©)
        updateMetaTags();
    }

    // ë©”íƒ€ íƒœê·¸ ì—…ë°ì´íŠ¸
    function updateMetaTags() {
        const versionName = version === 'krv' ? 'ê°œì—­ê°œì •' : 'ìƒˆë²ˆì—­';
        
        // ì œëª©ì— ë²„ì „ ëª…ì‹œ (SEO í•µì‹¬: ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ì–´ë–¤ ë²„ì „ì¸ì§€ ë°”ë¡œ ì•Œ ìˆ˜ ìˆê²Œ í•¨)
        const title = `${book_title} ${chapter}ì¥ (${versionName}) - ì†ê°€ë½ ì„±ê²½`;
        
        // ì„¤ëª…ë„ ë²„ì „ì— ë§ê²Œ ìµœì í™” (í‚¤ì›Œë“œ ë°€ë„ ë†’ì´ê¸°)
        let description = '';
        let keywords = '';
        
        if (version === 'rnksv') {
            // ìƒˆë²ˆì—­ì¼ ë•Œì˜ ì „ëµì  ë¬¸êµ¬ - 'ë¬´ë£Œ', 'ê´‘ê³  ì—†ëŠ”' ê°•ì¡°
            description = `${book_title} ${chapter}ì¥ ìƒˆë²ˆì—­ ì„±ê²½ ë¬´ë£Œ ì½ê¸°. ê´‘ê³  ì—†ì´ ê¹”ë”í•œ ì†ê°€ë½ ì„±ê²½ì—ì„œ í˜„ëŒ€ì¸ì„ ìœ„í•œ ì‰¬ìš´ ìš°ë¦¬ë§ ë²ˆì—­ìœ¼ë¡œ ë§ì”€ì„ ë¬µìƒí•´ë³´ì„¸ìš”.`;
            keywords = `ë¬´ë£Œì„±ê²½, ìƒˆë²ˆì—­, ìƒˆë²ˆì—­ì„±ê²½, ${book_title}, ${book_title}${chapter}ì¥, ì‰¬ìš´ì„±ê²½, ìš°ë¦¬ë§ì„±ê²½, ì˜¨ë¼ì¸ì„±ê²½, ëª¨ë°”ì¼ì„±ê²½, ê´‘ê³ ì—†ëŠ”ì„±ê²½`;
        } else {
            // ê°œì—­ê°œì •ì¼ ë•Œì˜ ì „ëµì  ë¬¸êµ¬ - 'ë¬´ë£Œ', 'ê´‘ê³  ì—†ëŠ”' ê°•ì¡°
            description = `${book_title} ${chapter}ì¥ ê°œì—­ê°œì • ì„±ê²½ ë¬´ë£Œ ì½ê¸°. ê´‘ê³  ì—†ì´ ê¹”ë”í•œ ì†ê°€ë½ ì„±ê²½ì—ì„œ í•œêµ­ êµíšŒ í‘œì¤€ ë²ˆì—­ìœ¼ë¡œ ë§ì”€ì„ ë¬µìƒí•´ë³´ì„¸ìš”.`;
            keywords = `ë¬´ë£Œì„±ê²½, ê°œì—­ê°œì •, ê°œì—­ê°œì •ì„±ê²½, ${book_title}, ${book_title}${chapter}ì¥, ì„±ê²½, ì˜¨ë¼ì¸ì„±ê²½, ëª¨ë°”ì¼ì„±ê²½, ê´‘ê³ ì—†ëŠ”ì„±ê²½`;
        }
        
        const url = window.location.href;
        
        // í˜ì´ì§€ íƒ€ì´í‹€
        document.title = title;
        
        // Canonical URL ì—…ë°ì´íŠ¸ (SEO)
        $('#canonical-url').attr('href', url);
        
        // OG íƒœê·¸ ì—…ë°ì´íŠ¸
        $('meta[property="og:title"]').attr('content', title);
        $('meta[property="og:description"]').attr('content', description);
        $('meta[property="og:url"]').attr('content', url);
        
        // Twitter íƒœê·¸ ì—…ë°ì´íŠ¸
        $('meta[name="twitter:title"]').attr('content', title);
        $('meta[name="twitter:description"]').attr('content', description);
        
        // Description ë° Keywords ë©”íƒ€ íƒœê·¸
        $('meta[name="description"]').attr('content', description);
        $('meta[name="keywords"]').attr('content', keywords);
        
        // JSON-LD Structured Data ì¶”ê°€/ì—…ë°ì´íŠ¸ (SEO)
        updateStructuredData(title, description, url, versionName);
    }
    
    // Structured Data (JSON-LD) ì—…ë°ì´íŠ¸
    function updateStructuredData(title, description, url, versionName) {
        // ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ì œê±°
        $('#structured-data').remove();
        
        const structuredData = {
            "@context": "https://schema.org",
            "@type": "WebPage",
            "name": title,
            "description": description,
            "url": url,
            "inLanguage": "ko-KR",
            "isPartOf": {
                "@type": "WebSite",
                "name": "ì†ê°€ë½ ì„±ê²½",
                "url": "https://fingerbible.com",
                "description": "ëª¨ë°”ì¼ê¸°ê¸°ì—ì„œ í¸ë¦¬í•˜ê²Œ ë³¼ ìˆ˜ ìˆëŠ” ì˜¨ë¼ì¸ í•œê¸€ ì„±ê²½",
                "potentialAction": {
                    "@type": "SearchAction",
                    "target": "https://fingerbible.com/{search_term_string}",
                    "query-input": "required name=search_term_string"
                }
            },
            "about": {
                "@type": "Book",
                "name": book_title,
                "bookEdition": versionName,
                "inLanguage": "ko-KR",
                "genre": "Religious Text"
            },
            "publisher": {
                "@type": "Organization",
                "name": "ì†ê°€ë½ ì„±ê²½",
                "url": "https://fingerbible.com"
            },
            "breadcrumb": {
                "@type": "BreadcrumbList",
                "itemListElement": [
                    {
                        "@type": "ListItem",
                        "position": 1,
                        "name": "í™ˆ",
                        "item": "https://fingerbible.com"
                    },
                    {
                        "@type": "ListItem",
                        "position": 2,
                        "name": book_title,
                        "item": `https://fingerbible.com/${book}/1`
                    },
                    {
                        "@type": "ListItem",
                        "position": 3,
                        "name": `${chapter}ì¥`,
                        "item": url
                    }
                ]
            }
        };
        
        // JSON-LD ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
        const script = document.createElement('script');
        script.id = 'structured-data';
        script.type = 'application/ld+json';
        script.text = JSON.stringify(structuredData, null, 2);
        document.head.appendChild(script);
    }

    // URLì—ì„œ ìƒíƒœ ë¡œë“œ
    function loadFromUrl() {
        const params = getUrlParams();
        
        if (params.version) {
            version = params.version;
        }
        
        if (params.book) {
            book = params.book;
            // í•´ë‹¹ ì±…ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            const bookElement = $('.books > div[data-book="' + book + '"]');
            if (bookElement.length > 0) {
                $('.books > div').removeClass('selected');
                bookElement.addClass('selected');
            } else {
                // ì˜ëª»ëœ ì±… ì´ë¦„ì´ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ
                book = 'gen';
                console.warn('Invalid book code:', params.book, '- redirecting to Genesis');
            }
        }
        
        if (params.chapter) {
            const chapterNum = params.chapter;
            if (!isNaN(chapterNum) && chapterNum > 0) {
                chapter = chapterNum;
            }
        }
        
        // ìµœëŒ€ ì¥ìˆ˜ í™•ì¸
        l_chapter = parseInt($('.books > div.selected').attr('data-ch'));
        if (chapter > l_chapter) {
            console.warn('Chapter', chapter, 'exceeds max chapters', l_chapter, 'for', book);
            chapter = 1;
        }
    }

    // ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸° ì´ë²¤íŠ¸ ì²˜ë¦¬
    window.addEventListener('popstate', function(event) {
        if (event.state) {
            // íˆìŠ¤í† ë¦¬ ìŠ¤í…Œì´íŠ¸ì—ì„œ ë°ì´í„° ë³µì›
            book = event.state.book;
            chapter = event.state.chapter;
            version = event.state.version;
            
            // UI ì—…ë°ì´íŠ¸
            $('.books > div').removeClass('selected');
            $('.books > div[data-book="' + book + '"]').addClass('selected');
            
            $('#current select').val(version);
            $('body').attr('data-version', version);
            
            if (version == 'krv') {
                $('html').css('--color-scheme', '#00beff');
            } else {
                $('html').css('--color-scheme', '#ff0044');
            }
            
            get_chapters();
            read_once();
        }
    });

    function read_once() {
        $('body').addClass('loading')
        firebase.database().ref('/' + version + '/' + book + '/c' + chapter).once('value').then(function (snapshot) {
            bible_json = snapshot.val()
            rmv_letter(bible_json)
            $('body').removeClass('loading')
        })
        book_title = $('.books').find('[data-book="' + book + '"]').text()
        $('.title').text(book_title + ' ' + chapter + 'ì¥')
        if (!$('body').hasClass('left_open')) {
            var t_h = $('.books > div.selected').offset().top - $(window).height() / 2 + $('.books > div').height() / 2
            $('.books').scrollTop(t_h)
            t_h = $('.chapters > li.selected').offset().top - $(window).height() / 2 + $('.chapters > li').height() / 2
            $('.chapters').scrollTop(t_h)
        }
        $('#b_text').scrollTop(0)
        
        // URL ì—…ë°ì´íŠ¸
        updateUrl();
    }

    function get_chapters() {
        $('.chapters').html('')
        l_chapter = parseInt($('.books > div.selected').attr('data-ch'))
        for (var k = 1; k < l_chapter + 1; k++) {
            $('<li>' + k + '</li>').appendTo('.chapters')
        }
        // $('.chapters').find('li:first-of-type').addClass('selected')
        setTimeout(function () {
            $('body').removeClass('c_reading')
        }, 200)
        $('.chapters > li').eq(chapter - 1).addClass('selected')
    }

    $('.books > div').on('click', function () {
        $('body').addClass('c_reading')
        $('.books > div').removeClass()
        $(this).addClass('selected')
        book = $(this).attr('data-book')
        chapter = 1
        get_chapters()
        read_once()
        setCookie("book", book, 365);
        // URL ì—…ë°ì´íŠ¸ëŠ” read_once()ì—ì„œ ì²˜ë¦¬ë¨
    })

    $('body .btn.left').on('click', function () {
        $('body').toggleClass('left_open')
    })

    $('body .btn.right').on('click', function () {
        $('body').toggleClass('right_open')
    })

    $('.main').on('touchend', function () {
        if ($('body').hasClass('right_open')) {
            $('body').removeClass('right_open')
        } else if ($('body').hasClass('left_open')) {
            $('body').removeClass('left_open')
        }
    })
    $('header .title').on('click', function () {
        if ($('body').hasClass('right_open')) {
            $('body').removeClass('right_open')
        } else if ($('body').hasClass('left_open')) {
            $('body').removeClass('left_open')
        }
    })

    $('.chapters').on('click', 'li', function (event) {
        $('.chapters > li').removeClass()
        $(this).addClass('selected')
        chapter = parseInt($(this).text())
        read_once()
        $('body').removeClass('left_open')
        setCookie("chapter", chapter, 365);
        // URL ì—…ë°ì´íŠ¸ëŠ” read_once()ì—ì„œ ì²˜ë¦¬ë¨
    });



    var f_size = 16

    $('#font_inc').on('click', function () {
        f_size += 1
        if (f_size > 72) { f_size = 72 }
        $('.main').find('.text').css('font-size', f_size + 'px')
        setCookie("fontsize", f_size, 365);
    })

    $('#font_dec').on('click', function () {
        f_size -= 1
        if (f_size < 6) { f_size = 6 }
        $('.main').find('.text').css('font-size', f_size + 'px')
        setCookie("fontsize", f_size, 365);
    })

    $('#inline').on('click', function () {
        $('body').toggleClass('inline')
    })

    $('#colormode').on('click', function () {
        $('body').toggleClass('bright')
    })


    function bundle() {
        var pre_val = verses[0]
        var s_bundle = pre_val
        bundle_txt = ''
        for (var k = 1; k < verses.length + 1; k++) {
            if ((verses[k] - pre_val) != 1) {
                //not continuous 
                v_bundle.push([s_bundle, pre_val])
                s_bundle = verses[k]
                pre_val = verses[k]
            } else {
                //continuous
                pre_val = verses[k]
            }
        }
        for (var k = 0; k < v_bundle.length; k++) {
            var last_comma = ','
            if (k == v_bundle.length - 1) {
                last_comma = ''
            }
            if (v_bundle[k][0] == v_bundle[k][1]) {
                bundle_txt += v_bundle[k][0] + last_comma
            } else {
                bundle_txt += v_bundle[k][0] + '~' + v_bundle[k][1] + last_comma
            }
        }

        if (bundle_txt == '') {
            $('body').removeClass('copymode')
        } else {
            $('body').addClass('copymode')
        }
    }

    var copy_txt = ''

    function clear() {
        copy_txt = ''
        verses = []
        v_bundle = []
        $('body').removeClass('copymode')
        $('.text > div.on').removeClass('on')
        $('#copyme').remove()
        var txt = '<input id="copyme" style="position: absolute;left: -999px;top:-999px;opacity: 0;z-index: -1;pointer-events: none" type="text" value="">'
        $('body').append(txt)
    }

    $('.main').on('click', '.text > div', function () {
        if (!$('body').hasClass('left_open') && !$('body').hasClass('right_open')) {
            $(this).toggleClass('on')
            copy_txt = ''
            verses = []
            v_bundle = []
            $('.text > div.on').each(function () {
                copy_txt += $(this).find('p').text() + ' '
                verses.push(parseInt($(this).find('span').text()))
            })
            bundle()
            $('.selection').text(book_title + ' ' + chapter + 'ì¥ ' + bundle_txt + 'ì ˆ')
            copy_txt += ' (' + $('.selection').text() + ')'
        }
        if (copy_txt[0] == ' ') {
            copy_txt = copy_txt.replace(' ', '')
        }
        copy_txt = copy_txt.replace(/\  /g, ' ')
        $('#copyme').val(copy_txt)
    })

    $('.close').on('click', function () {
        clear()
    })

    $('.copy_me').on('click', function () {
        setTimeout(function () {
            clear()
        }, 200)

    })

    new Clipboard('.copy_me');




    function setCookie(cname, cvalue, exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
        var expires = "expires=" + d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    function getCookie(cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

    function ini_cookie() {
        // URL íŒŒë¼ë¯¸í„° ìš°ì„  ì ìš©
        const urlParams = getUrlParams();
        const hasUrlParams = urlParams.book || urlParams.chapter || urlParams.version;
        
        if (hasUrlParams) {
            // URLì—ì„œ ë¡œë“œ
            loadFromUrl();
        } else {
            // ì¿ í‚¤ì—ì„œ ë¡œë“œ
            if (getCookie('book')) {
                book = getCookie('book')
                chapter = parseInt(getCookie('chapter'))
                $('.books > div').removeClass('selected')
                $('.books > div[data-book="' + book + '"]').addClass('selected')
            }
            
            if (getCookie('version')) {
                version = getCookie('version')
            }
        }
        
        // chapter = 1
        l_chapter = parseInt($('.books > div.selected').attr('data-ch'))
        if (chapter > l_chapter || chapter == null || typeof chapter == 'undefined' || chapter == NaN || chapter == 'NaN') { chapter = 1 }
        get_chapters()

        // ë²„ì „ UI ì—…ë°ì´íŠ¸
        $('#current select').val(version)
        $('body').attr('data-version', version)
        if (version == 'krv') {
            $('html').css('--color-scheme', '#00beff')
        } else {
            $('html').css('--color-scheme', '#ff0044')
        }

        // ì²« ë¡œë“œ ì‹œ replaceState ì‚¬ìš© (íˆìŠ¤í† ë¦¬ ì¶”ê°€ ì•ˆ í•¨)
        read_once_initial()
        
        if (getCookie('fontsize')) {
            f_size = parseInt(getCookie('fontsize'))
            if (f_size > 72) { f_size = 72 }
            $(document).find('.main .text').css('font-size', f_size + 'px')
        }
    }

    // ì´ˆê¸° ë¡œë“œ ì „ìš© í•¨ìˆ˜ (URL replaceState ì‚¬ìš©)
    function read_once_initial() {
        $('body').addClass('loading')
        firebase.database().ref('/' + version + '/' + book + '/c' + chapter).once('value').then(function (snapshot) {
            bible_json = snapshot.val()
            rmv_letter(bible_json)
            $('body').removeClass('loading')
        })
        book_title = $('.books').find('[data-book="' + book + '"]').text()
        $('.title').text(book_title + ' ' + chapter + 'ì¥')
        if (!$('body').hasClass('left_open')) {
            var t_h = $('.books > div.selected').offset().top - $(window).height() / 2 + $('.books > div').height() / 2
            $('.books').scrollTop(t_h)
            t_h = $('.chapters > li.selected').offset().top - $(window).height() / 2 + $('.chapters > li').height() / 2
            $('.chapters').scrollTop(t_h)
        }
        $('#b_text').scrollTop(0)
        
        // ì²« ë¡œë“œ ì‹œì—ëŠ” replaceState ì‚¬ìš©
        updateUrl(false);
    }

    ini_cookie()

    function sortResults(json) {
        const ordered = {};
        Object.keys(json).sort().forEach(function (key) {
            ordered[key] = json[key];
        });
        return ordered
    }

    function rmv_letter(json) {
        Object.keys(json).forEach(function (key) {
            var t_txt = json[key]
            var new_key = key.substr(1, key.length)
            json[new_key] = t_txt
            delete json[key]
            // console.log(key)
        });
        bible_text.bjson = bible_json
    }

    var bible_text = new Vue({
        el: '#b_text',
        data: {
            bjson: {}
        }
    })

    $('#current select').on('change', function () {
        console.log($(this).find('option:selected').val())
        version = $(this).find('option:selected').val()
        read_once()
        $('body').attr('data-version', version)
        setCookie("version", version, 365);
        if (version == 'krv') {
            $('html').css('--color-scheme', '#00beff')
        } else {
            $('html').css('--color-scheme', '#ff0044')
        }
        // URL ì—…ë°ì´íŠ¸ëŠ” read_once()ì—ì„œ ì²˜ë¦¬ë¨
    })

    ////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////

    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            console.log(user);
            console.log(user.uid);
            firebase.database().ref('/users').once('value', function (snapshot) {
                if (snapshot.hasChild(user.uid)) {
                    console.log('exist')
                } else {
                    console.log('not yet')
                    // permission issue
                    // firebase.database().ref('/users'+user.uid).set({
                    //     'email':user.email
                    // })
                }
            })
        } else { }
    });

    ////////////////////////////////////////////////////////////
    // Service Worker Registration (PWA)
    ////////////////////////////////////////////////////////////
    
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then((registration) => {
                    console.log('[PWA] Service Worker registered successfully:', registration.scope);
                    
                    // ì—…ë°ì´íŠ¸ ì²´í¬
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('[PWA] New Service Worker found!');
                        
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // ìƒˆ ë²„ì „ ì‚¬ìš© ê°€ëŠ¥
                                console.log('[PWA] New version available! Please refresh.');
                                if (confirm('ìƒˆë¡œìš´ ë²„ì „ì´ ìˆìŠµë‹ˆë‹¤. ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                    window.location.reload();
                                }
                            }
                        });
                    });
                })
                .catch((error) => {
                    console.error('[PWA] Service Worker registration failed:', error);
                });
        });

        // ì„œë¹„ìŠ¤ ì›Œì»¤ ì œì–´ ë³€ê²½ ê°ì§€
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            console.log('[PWA] Controller changed, reloading page...');
            window.location.reload();
        });
    }

    ////////////////////////////////////////////////////////////
    // PWA Install Prompt
    ////////////////////////////////////////////////////////////
    
    let deferredPrompt;
    let installPromptDismissed = localStorage.getItem('pwa-install-dismissed');
    
    window.addEventListener('beforeinstallprompt', (e) => {
        console.log('[PWA] Install prompt triggered');
        // ê¸°ë³¸ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ë°©ì§€
        e.preventDefault();
        // ë‚˜ì¤‘ì— ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì´ë²¤íŠ¸ ì €ì¥
        deferredPrompt = e;
        
        // ì„¤ì¹˜ ë²„íŠ¼ í‘œì‹œ
        updateInstallButton();
        
        // ì»¤ìŠ¤í…€ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
        showInstallPromotion();
    });

    // ì»¤ìŠ¤í…€ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
    function showInstallPromotion() {
        // ì´ë¯¸ ë¬´ì‹œí–ˆê±°ë‚˜ ì„¤ì¹˜ë˜ì–´ ìˆìœ¼ë©´ í‘œì‹œí•˜ì§€ ì•ŠìŒ
        if (installPromptDismissed || window.matchMedia('(display-mode: standalone)').matches) {
            return;
        }
        
        // 3ì´ˆ í›„ì— í‘œì‹œ (ì‚¬ìš©ìê°€ í˜ì´ì§€ë¥¼ ë‘˜ëŸ¬ë³¼ ì‹œê°„ ì œê³µ)
        setTimeout(() => {
            const promptElement = document.getElementById('pwa-install-prompt');
            if (promptElement && deferredPrompt) {
                promptElement.style.display = 'block';
            }
        }, 3000);
    }

    // ì„¤ì • ë©”ë‰´ì˜ ì„¤ì¹˜í•˜ê¸° ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
    function updateInstallButton() {
        const installBtn = document.getElementById('install_app');
        if (!installBtn) return;
        
        // ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        const isInstalled = window.matchMedia('(display-mode: standalone)').matches;
        
        if (isInstalled) {
            // ì„¤ì¹˜ë¨: ë²„íŠ¼ ìˆ¨ê¹€
            installBtn.style.display = 'none';
        } else if (deferredPrompt || isIOS()) {
            // ì„¤ì¹˜ ê°€ëŠ¥: ë²„íŠ¼ í‘œì‹œ
            installBtn.style.display = 'block';
        }
    }

    // PWA ì„¤ì¹˜ ì²˜ë¦¬ í•¨ìˆ˜
    async function handlePWAInstall() {
        if (!deferredPrompt) {
            console.log('[PWA] No install prompt available');
            // iOSì¼ ê²½ìš° ì•ˆë‚´ ë©”ì‹œì§€
            if (isIOS()) {
                showIOSInstallInstructions();
            }
            return;
        }
        
        // í”„ë¡¬í”„íŠ¸ í‘œì‹œ
        deferredPrompt.prompt();
        
        // ì‚¬ìš©ì ì„ íƒ ëŒ€ê¸°
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`[PWA] User response: ${outcome}`);
        
        if (outcome === 'accepted') {
            console.log('[PWA] User accepted the install prompt');
        } else {
            console.log('[PWA] User dismissed the install prompt');
        }
        
        // ì‚¬ìš©í•œ í”„ë¡¬í”„íŠ¸ ì œê±°
        deferredPrompt = null;
        
        // UI ì—…ë°ì´íŠ¸
        const promptElement = document.getElementById('pwa-install-prompt');
        if (promptElement) {
            promptElement.style.display = 'none';
        }
        updateInstallButton();
    }

    // ì„¤ì¹˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.addEventListener('DOMContentLoaded', () => {
        const installBtn = document.getElementById('pwa-install-btn');
        const closeBtn = document.getElementById('pwa-close-btn');
        const promptElement = document.getElementById('pwa-install-prompt');
        const menuInstallBtn = document.getElementById('install_app');
        
        // í•˜ë‹¨ í”„ë¡¬í”„íŠ¸ì˜ ì„¤ì¹˜ ë²„íŠ¼
        if (installBtn) {
            installBtn.addEventListener('click', handlePWAInstall);
        }
        
        // ì„¤ì • ë©”ë‰´ì˜ ì„¤ì¹˜ ë²„íŠ¼
        if (menuInstallBtn) {
            menuInstallBtn.addEventListener('click', () => {
                // ìš°ì¸¡ íŒ¨ë„ ë‹«ê¸°
                $('body').removeClass('right_open');
                // ì„¤ì¹˜ ì²˜ë¦¬
                handlePWAInstall();
            });
        }
        
        // í”„ë¡¬í”„íŠ¸ ë‹«ê¸° ë²„íŠ¼
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                if (promptElement) {
                    promptElement.style.display = 'none';
                }
                // ì˜¤ëŠ˜ì€ ë” ì´ìƒ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                const today = new Date().toDateString();
                localStorage.setItem('pwa-install-dismissed', today);
            });
        }
        
        // ì„¤ì¹˜ ë²„íŠ¼ í‘œì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateInstallButton();
    });

    // iOS ê°ì§€
    function isIOS() {
        return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }

    // iOS ì„¤ì¹˜ ì•ˆë‚´
    function showIOSInstallInstructions() {
        alert('iOSì—ì„œ ì„¤ì¹˜í•˜ê¸°:\n\n1. í•˜ë‹¨ì˜ ê³µìœ  ë²„íŠ¼(â¬†ï¸)ì„ ëˆ„ë¥´ì„¸ìš”\n2. "í™ˆ í™”ë©´ì— ì¶”ê°€"ë¥¼ ì„ íƒí•˜ì„¸ìš”\n3. "ì¶”ê°€" ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”');
    }

    // ì•± ì„¤ì¹˜ ì™„ë£Œ ì´ë²¤íŠ¸
    window.addEventListener('appinstalled', (evt) => {
        console.log('[PWA] App installed successfully');
        const promptElement = document.getElementById('pwa-install-prompt');
        if (promptElement) {
            promptElement.style.display = 'none';
        }
        
        // ì„¤ì¹˜ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        updateInstallButton();
        
        // ì„¤ì¹˜ ì™„ë£Œ ë©”ì‹œì§€ (ì„ íƒì‚¬í•­)
        // alert('ì†ê°€ë½ ì„±ê²½ì´ í™ˆ í™”ë©´ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
    });
    
    // ë§¤ì¼ í•œ ë²ˆì”©ë§Œ í”„ë¡¬í”„íŠ¸ í‘œì‹œë˜ë„ë¡ ì²´í¬
    function checkInstallPromptDismissed() {
        const dismissed = localStorage.getItem('pwa-install-dismissed');
        if (dismissed) {
            const dismissedDate = new Date(dismissed).toDateString();
            const today = new Date().toDateString();
            if (dismissedDate !== today) {
                // ë‚ ì§œê°€ ë°”ë€Œì—ˆìœ¼ë©´ ë‹¤ì‹œ í‘œì‹œ
                localStorage.removeItem('pwa-install-dismissed');
                installPromptDismissed = null;
            }
        }
    }
    
    checkInstallPromptDismissed();

    ////////////////////////////////////////////////////////////
    // Online/Offline Detection
    ////////////////////////////////////////////////////////////
    
    window.addEventListener('online', () => {
        console.log('[PWA] Back online');
        // ì˜¨ë¼ì¸ ìƒíƒœ UI ì—…ë°ì´íŠ¸
    });

    window.addEventListener('offline', () => {
        console.log('[PWA] Gone offline');
        // ì˜¤í”„ë¼ì¸ ìƒíƒœ UI ì—…ë°ì´íŠ¸
    });

    ////////////////////////////////////////////////////////////
    // iOS Standalone Mode Detection
    ////////////////////////////////////////////////////////////
    
    if (window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches) {
        console.log('[PWA] Running in standalone mode');
        // ìŠ¤íƒ ë“œì–¼ë¡  ëª¨ë“œì—ì„œë§Œ ì‹¤í–‰í•  ì½”ë“œ
    }
</script>

</html>